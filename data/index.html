<!-- data/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Water Level Monitor</title>
    <script src="chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-gap: 20px;
            padding: 20px;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .current-level {
            font-size: 24px;
            text-align: center;
        }
        .settings-form {
            display: grid;
            gap: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card current-level">
            <h2>Current Water Level</h2>
            <div id="currentLevel">Loading...</div>
            <div id="currentTime"></div>
        </div>
        
        <div class="card">
            <h2>Water Level Graph</h2>
            <canvas id="waterLevelChart"></canvas>
        </div>
        
        <div class="card">
            <h2>Settings</h2>
            <form class="settings-form" id="settingsForm">
                <div>
                    <label>Measurement Interval (seconds):</label>
                    <input type="number" id="interval" min="1" required>
                </div>
                <div>
                    <label>Calibration Offset (cm):</label>
                    <input type="number" id="calibration" step="0.1" required>
                </div>
                <button type="submit">Save Settings</button>
            </form>
        </div>
        
        <div class="card">
            <h2>Date & Time Settings</h2>
            <form class="settings-form" id="timeForm">
                <div>
                    <label>Date:</label>
                    <input type="date" id="date" required>
                </div>
                <div>
                    <label>Time:</label>
                    <input type="time" id="time" required>
                </div>
                <button type="submit">Set Time</button>
            </form>
        </div>
        
        <div class="card">
            <h2>Data Management</h2>
            <button onclick="downloadData()">Download Data</button>
            <button onclick="deleteData()" style="background: #dc3545;">Delete All Data</button>
        </div>
    </div>

    <script>
        let chart;
        
        async function updateCurrentLevel() {
            const response = await fetch('/api/current');
            const data = await response.json();
            document.getElementById('currentLevel').textContent = `${data.level.toFixed(1)} cm`;
            document.getElementById('currentTime').textContent = data.time;
        }
        
        async function updateChart() {
            const response = await fetch('/api/data');
            const text = await response.text();
            const rows = text.trim().split('\n').map(row => {
                const [datetime, level] = row.split(',');
                return {
                    x: datetime,
                    y: parseFloat(level)
                };
            });
            
            if (!chart) {
                const ctx = document.getElementById('waterLevelChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Water Level',
                            data: rows,
                            borderColor: '#007bff',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour'
                                }
                            }
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = rows;
                chart.update();
            }
        }
        
        document.getElementById('settingsForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('interval', document.getElementById('interval').value);
            formData.append('calibration', document.getElementById('calibration').value);
            
            await fetch('/api/settings', {
                method: 'POST',
                body: formData
            });
            
            alert('Settings saved');
        };
        
        document.getElementById('timeForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('date', document.getElementById('date').value);
            formData.append('time', document.getElementById('time').value);
            
            await fetch('/api/time', {
                method: 'POST',
                body: formData
            });
            
            alert('Time updated');
        };
        
        async function downloadData() {
            const response = await fetch('/api/data');
            const text = await response.text();
            const blob = new Blob([text], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'water_level_data.csv';
            a.click();
        }
        
        async function deleteData() {
            if (confirm('Are you sure you want to delete all data?')) {
                await fetch('/api/delete', { method: 'POST' });
                updateChart();
            }
        }
        
        // Update current level and chart every 30 seconds
        setInterval(() => {
            updateCurrentLevel();
            updateChart();
        }, 30000);
        
        // Initial update
        updateCurrentLevel();
        updateChart();
    </script>
</body>
</html>